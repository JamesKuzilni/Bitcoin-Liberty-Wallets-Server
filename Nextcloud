#!/usr/bin/env python3
import subprocess
import secrets
import string

import os
import subprocess
import secrets
import string

# Generate a random alphanumeric password
password_length = 12  # You can adjust the length as needed
alphabet = string.ascii_letters + string.digits
random_password = ''.join(secrets.choice(alphabet) for _ in range(password_length))

# Print the generated password
print(f"Generated MariaDB password: {random_password}")

# Expand the tilde (~) character to the home directory path
home_dir = os.path.expanduser("~")
passwords_file = os.path.join(home_dir, ".Passwords")

# Append the generated password to the ~/.Passwords file with a label
with open(passwords_file, "a") as file:
    file.write(f"dbpassword: {random_password}\n")

# Define the SQL commands
sql_commands = [
    "CREATE DATABASE nextcloud;",
    "SHOW DATABASES;",
    f"GRANT ALL PRIVILEGES ON nextcloud.* TO 'nextcloud'@'localhost' IDENTIFIED BY '{random_password}';",
    "FLUSH PRIVILEGES;",
]

# The command to run
command = "sudo mariadb"

try:
    # Run the MariaDB client and execute SQL commands
    child = subprocess.Popen(command, shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    
    # Execute SQL commands and capture the output
    for sql_command in sql_commands:
        child.stdin.write(sql_command + "\n")
    
    # Capture the output from the MariaDB client
    output, _ = child.communicate()

    # Print the output
    print(output)
except subprocess.CalledProcessError as e:
    print(f"Failed to execute SQL commands with error code {e.returncode}.")
except FileNotFoundError:
    print("Error: The 'sudo' or 'mariadb' command was not found.")
except Exception as e:
    print(f"An unexpected error occurred: {str(e)}")
